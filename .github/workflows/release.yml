name: Build & Release

on:
  push:
    tags:
      - 'v*'          # ä»»ä½• v å¼€å¤´çš„ tag è§¦å‘ï¼Œå¦‚ v0.2.4

# å…è®¸å†™å…¥ GitHub Release
permissions:
  contents: write

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 1. åˆ›å»º GitHub Releaseï¼ˆå…ˆè¡Œï¼Œåç»­ job ä¸Šä¼ äº§ç‰©ï¼?
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create.outputs.id }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${GITHUB_REF_NAME}"
          echo "Extracting changelog for $VERSION"

          # ä»?CHANGELOG.md æå–å½“å‰ç‰ˆæœ¬çš„å†…å®¹ï¼ˆä¸¤ä¸ª ## ä¹‹é—´çš„éƒ¨åˆ†ï¼‰
          python3 - <<'EOF'
          import re, os, sys

          version = os.environ.get("GITHUB_REF_NAME", "")
          with open("CHANGELOG.md", "r", encoding="utf-8") as f:
              content = f.read()

          # åŒ¹é… ## [vX.Y.Z] å¼€å¤´çš„æ®µè½ï¼Œæå–åˆ°ä¸‹ä¸€ä¸?## ä¹‹å‰
          pattern = re.compile(
              r'^## \[' + re.escape(version) + r'\].*?\n(.*?)(?=^## \[|\Z)',
              re.MULTILINE | re.DOTALL
          )
          m = pattern.search(content)
          notes = m.group(1).strip() if m else "_No changelog entry found for this version._"

          # æ‹¼æ¥ä¸‹è½½è¡¨æ ¼
          body = f"""## LynxShell {version}

          {notes}

          ---

          ### ä¸‹è½½ / Downloads
          | å¹³å° | æ–‡ä»¶ | è¯´æ˜ |
          |------|------|------|
          | Windows x64 | `*.msi` / `*-setup.exe` | Windows å®‰è£…åŒ?|
          | macOS (Apple Silicon) | `*_aarch64.dmg` | macOS ARM64 ç£ç›˜æ˜ åƒ |
          | macOS (Intel) | `*_x64.dmg` | macOS x64 ç£ç›˜æ˜ åƒ |
          | Linux x64 | `.AppImage` / `.deb` | Linux å¯æ‰§è¡Œæ–‡ä»¶ä¸å®‰è£…åŒ?|

          > æºç åŒ…ç”± GitHub è‡ªåŠ¨ç”Ÿæˆï¼Œè§ä¸‹æ–¹ **Assets** ä¸­çš„ `Source code`ã€?
          """

          # å†™å…¥ GitHub Outputï¼ˆå¤šè¡Œï¼‰
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write("notes<<NOTES_EOF\n")
              f.write(body + "\n")
              f.write("NOTES_EOF\n")
          EOF

      - name: Create GitHub Release
        id: create
        uses: softprops/action-gh-release@v2
        with:
          name: LynxShell ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          body: ${{ steps.changelog.outputs.notes }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 2. Windows æ„å»º (x64)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-windows:
    name: Build Windows (x64)
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        shell: powershell
        run: |
          $ver = $env:GITHUB_REF_NAME.TrimStart('v')
          Write-Host "Setting version to $ver"

          # æ›´æ–° tauri.conf.json ä¸­çš„ç‰ˆæœ¬
          $tauriConf = Get-Content src-tauri/tauri.conf.json -Raw | ConvertFrom-Json
          $tauriConf.version = $ver
          $tauriConf | ConvertTo-Json -Depth 10 | Set-Content src-tauri/tauri.conf.json

          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬
          npm version $ver --no-git-tag-version --allow-same-version

      - name: Build Tauri App (Windows)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: npx tauri

      - name: Upload Windows artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 3. macOS æ„å»º (Apple Silicon - aarch64)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-macos-aarch64:
    name: Build macOS (Apple Silicon)
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        run: |
          VER="${GITHUB_REF_NAME#v}"
          echo "Setting version to $VER"

          # æ›´æ–° tauri.conf.json ä¸­çš„ç‰ˆæœ¬ (ä½¿ç”¨ node è„šæœ¬ä»¥ä¿æŒ?JSON æ ¼å¼)
          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$VER';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

          # æ›´æ–° package.json ä¸­çš„ç‰ˆæœ¬
          npm version $VER --no-git-tag-version --allow-same-version

      - name: Build Tauri App (macOS aarch64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: npx tauri
          args: --target aarch64-apple-darwin

      - name: Upload macOS (aarch64) artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz
            src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 4. macOS æ„å»º (Intel - x64)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-macos-x64:
    name: Build macOS (Intel x64)
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        run: |
          VER="${GITHUB_REF_NAME#v}"
          echo "Setting version to $VER"

          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$VER';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

          npm version $VER --no-git-tag-version --allow-same-version

      - name: Build Tauri App (macOS x64)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: npx tauri
          args: --target x86_64-apple-darwin

      - name: Upload macOS (x64) artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz
            src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app.tar.gz.sig

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # 5. Linux æ„å»º (x64)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-linux:
    name: Build Linux (x64)
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file libxdo-dev libssl-dev libayatana-appindicator3-dev librsvg2-dev

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync Tauri version with tag
        run: |
          VER="${GITHUB_REF_NAME#v}"
          echo "Setting version to $VER"

          node -e "
            const fs = require('fs');
            const conf = JSON.parse(fs.readFileSync('src-tauri/tauri.conf.json', 'utf8'));
            conf.version = '$VER';
            fs.writeFileSync('src-tauri/tauri.conf.json', JSON.stringify(conf, null, 2));
          "

          npm version $VER --no-git-tag-version --allow-same-version

      - name: Build Tauri App (Linux)
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tauriScript: npx tauri

      - name: Upload Linux artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            src-tauri/target/release/bundle/appimage/*.AppImage
            src-tauri/target/release/bundle/deb/*.deb
